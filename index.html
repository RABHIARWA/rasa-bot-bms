<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Rasa & Flask Chatbot</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="container">
            <h1></h1>

            <!-- Bouton d'ouverture du chat -->
            <button id="chat-widget-button" type="button"
                class="btn btn-primary rounded-circle position-fixed chat-sign-button"
                style="bottom: 20px; right: 20px;">ðŸ’¬</button>

            <!-- Chatbox -->
            <div id="chat-widget" class="card position-fixed shadow d-none"
                style="bottom: 100px; right: 20px; width: 300px;">
                <div class="card-header bg-primary text-white">
                    Chatbot
                    <button id="chat-widget-close-button" type="button"
                        class="btn-close float-end" aria-label="Close"></button>
                </div>

                <div class="messages" id="chat-widget-messages">
                    <!-- Messages affichÃ©s ici -->
                </div>

                <div class="card-footer d-flex align-items-center gap-2">
                    <!-- Champ upload (invisible) -->
                    <input type="file" id="image-upload" accept="image/*"
                        style="display: none;">

                    <!-- Bouton ðŸ“Ž -->
                    <button id="upload-button"
                        class="btn btn-secondary btn-sm">ðŸ“Ž</button>

                    <!-- Champ message -->
                    <input type="text" class="form-control"
                        id="chat-widget-input"
                        placeholder="Type your message...">
                </div>
            </div>

        </div>

        <script>
            const $messages = document.getElementById("chat-widget-messages");
            const RASA_URL = "http://localhost:5005";
            function addUserBubble(text) {
                if (!text) return;
                const row = document.createElement("div");
                row.className = "row user";
                const b = document.createElement("div");
                b.className = "bubble user";
                b.textContent = text;
                row.appendChild(b);
                $messages.appendChild(row);
                $messages.scrollTop = $messages.scrollHeight;
            }
            function addBotMessage(msg) {
                const row = document.createElement("div");
                row.className = "row bot";
                const b = document.createElement("div");
                b.className = "bubble bot";

                if (msg.text) {
                    const p = document.createElement("div");
                    p.textContent = msg.text;
                    b.appendChild(p);
                }

                if (msg.image) {
                    const img = document.createElement("img");
                    img.className = "msg-image";
                    img.src = msg.image;
                    img.alt = "";
                    b.appendChild(img);
                }

                if (Array.isArray(msg.buttons) && msg.buttons.length) {
                    const container = document.createElement("div");
                    container.className = "buttons";
                    msg.buttons.forEach(btn => {
                        const el = document.createElement("button");
                        el.type = "button";
                        el.textContent = btn.title ?? btn.payload ?? "Choose";
                        el.setAttribute("data-payload", btn.payload ?? btn.title ?? "");
                        el.addEventListener("click", (e) => {
                        // 1) Disable all sibling buttons to avoid double clicks
                        container.querySelectorAll("button").forEach(b => b.disabled = true);

                        // 2) Echo the chosen title as user's message (optional)
                        // addUserBubble(btn.title ?? "");

                        // 3) Send the payload back to the bot
                        const payload = el.getAttribute("data-payload");
                        console.log("payload ", payload);
                        if (payload) {
                            sendPayload(payload);
                        }
                        });
                        container.appendChild(el);
                        });
                        b.appendChild(container);
                }

                row.appendChild(b);
                $messages.appendChild(row);
                $messages.scrollTop = $messages.scrollHeight;
        }
            function sendPayload(payload) {
                fetch(RASA_URL.replace(/\/$/, "") + "/webhooks/rest/webhook", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                sender: "user",
                message: payload, // ðŸ‘ˆ intent name
                })
                })
                .then(r => r.json())
                .then(data => data.forEach(addBotMessage))
                .catch(err => {
                addBotMessage({ text: "âš ï¸ Could not reach bot: " + err.message });
                });
            }
$(document).ready(function () {
    

    // Ouvrir / fermer le chat
    $("#chat-widget-button").on("click", function () {
        $("#chat-widget").toggleClass("d-none");
    });

    $("#chat-widget-close-button").on("click", function () {
        $("#chat-widget").addClass("d-none");
    });

    // Envoi de message texte
    $("#chat-widget-input").keypress(function (event) {
        if (event.which === 13) {
            let userMessage = $("#chat-widget-input").val();
            $("#chat-widget-input").val("");

            // Affiche le message utilisateur
            addUserBubble(userMessage);
           
            // Envoi au bot Rasa
            $.ajax({
                type: "POST",
                url:"http://localhost:5005/webhooks/rest/webhook",
                contentType: "application/json",
                data: JSON.stringify({
                    sender: "user",
                    message: userMessage
                }),
                success: function (data) {
                    console.log("RÃ©ponse brute de Rasa :", data);
                    let botResponse = "";
                    if (data && data.length > 0) {
                        for (let i in data) {
                            console.log("msg: ", data[i]);
                            addBotMessage(data[i]);
                        }
                    } else {
                        addBotMessage( {text:"Pas de rÃ©ponse texte du bot."});
                    }
                },
                error: function (err) {
                    console.error("Erreur :", err);
                }
            });
        }
    });

    // Bouton ðŸ“Ž dÃ©clenche lâ€™upload
    $("#upload-button").on("click", function () {
        $("#image-upload").click();
    });

    // Upload dâ€™image
    $("#image-upload").on("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Image = e.target.result;

            // Affiche l'image dans le chat
            $("#chat-widget-messages").append(
                `<div><img src="${base64Image}" style="max-width: 100%; max-height: 200px;"></div>`
            );

            // Envoie l'image au bot
            $.ajax({
                type: "POST",
                url: "http://localhost:5005/webhooks/rest/webhook",
                contentType: "application/json",
                data: JSON.stringify({
                    sender: "user",
                    message: "Voici mon image",   // plus besoin de /intent
                    metadata: {
                        uploaded_image_url: base64Image,
                        image_uploaded: true   // le slot sera rempli par from_metadata
                    }
                     
                }),
                success: function (data) {
                    console.log("RÃ©ponse brute de Rasa :", data);
                    let botResponse = "";
                    if (data && data.length > 0) {
                        for (let i in data) {
                            console.log("msg: ", data[i]);
                            addBotMessage(data[i]);
                        }
                    } else {
                        addBotMessage( {text:"Pas de rÃ©ponse texte du bot."});
                    }
                },
                error: function (err) {
                    console.error("Erreur :", err);
                }
            });
            // RÃ©initialise lâ€™input
            $("#image-upload").val("");
        };

        reader.readAsDataURL(file);
    });

});
</script>
